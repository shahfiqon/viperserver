# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
#
# Copyright (c) 2011-2020 ETH Zurich.

name: Build, Test, and Publish

on:
  push: # run this workflow on every push
  pull_request: # run this workflow on every pull_request
  workflow_dispatch: # allow to manually trigger this workflow
    inputs:
      type:
        description: 'Specifies whether a stable or nightly release should be triggered. Has to be "stable" or "nightly".'
        required: true
        default: 'stable'
      tag_name:
        description: 'Tag name for stable release. Ignored if a nightly release will be created.'
        required: true
      release_name:
        description: 'Release title for stable release. Ignored if a nightly release will be created.'
        required: true
  schedule:
    - cron: '0 7 * * *' # run every day at 07:00 UTC


jobs:
  build-and-test:
    # build is the base job on which all other jobs depend
    # we enforce here that the nightly build job only runs in the main repo:
    if: (github.event_name == 'schedule' && github.repository == 'viperproject/viperserver') || (github.event_name != 'schedule')
    runs-on: ubuntu-latest
    container: viperproject/viperserver:v1
    steps:
      - name: Checkout ViperServer
        uses: actions/checkout@v2
        with:
          path: viperServer
      - name: Checkout Silver
        uses: actions/checkout@v2
        with:
          repository: viperproject/silver
          path: silver
      - name: Checkout Silicon
        uses: actions/checkout@v2
        with:
          repository: viperproject/silicon
          path: silicon
      - name: Checkout Carbon
        uses: actions/checkout@v2
        with:
          repository: viperproject/carbon
          path: carbon

      - name: Java Version
        run: java --version
      - name: Z3 Version
        run: z3 -version

      - name: Create version file
        run: |
          echo "ViperServer: commit $(git -C viperserver rev-parse HEAD)" >> versions.txt
          echo "Silicon: commit $(git -C silicon rev-parse HEAD)" >> versions.txt
          echo "Carbon: commit $(git -C carbon rev-parse HEAD)" >> versions.txt
          echo "Silver: commit $(git -C silver rev-parse HEAD)" >> versions.txt
        # first line overwrites versions.txt in case it already exists, all other append to the file
      - name: Upload version file
        uses: actions/upload-artifact@v2
        with:
          name: versions.txt
          path: versions.txt

      # create symlinks between and to Viper dependencies:
      - name: Create Silicon's sym links
        run: ln --symbolic ../silver
        working-directory: silicon
      - name: Create Carbon's sym links
        run: ln --symbolic ../silver
        working-directory: carbon
      - name: Create ViperServers's sym links
        run: ln --symbolic ../silver; ln --symbolic ../silicon; ln --symbolic ../carbon
        working-directory: viperServer

      - name: Set sbt cache variables
        run: echo "SBT_OPTS=-Dsbt.global.base=sbt-cache/.sbtboot -Dsbt.boot.directory=sbt-cache/.boot -Dsbt.ivy.home=sbt-cache/.ivy" >> $GITHUB_ENV
        # note that the cache path is relative to the directory in which sbt is invoked.

      - name: Cache SBT
        uses: actions/cache@v2
        with:
          path: |
            viperServer/sbt-cache/.sbtboot
            viperServer/sbt-cache/.boot
            viperServer/sbt-cache/.ivy/cache
          # <x>/project/target and <x>/target, where <x> is e.g. 'viperServer', are intentionally not
          # included as several occurrences of NoSuchMethodError exceptions have been observed during CI runs. It seems
          # like sbt is unable to correctly compute source files that require a recompilation. Therefore, we have
          # disabled caching of compiled source files altogether
          key: ${{ runner.os }}-sbt-no-precompiled-sources-${{ hashFiles('**/build.sbt') }}

      - name: Assemble ViperServer
        run: sbt "set test in assembly := {}" clean assembly
        working-directory: viperServer

      - name: Upload ViperServer artifact
        uses: actions/upload-artifact@v2
        with:
          name: viperserver
          path: viperServer/target/scala-2.13/viperserver.jar

      - name: Test ViperServer
        run: sbt test
        working-directory: viperServer

      - name: Upload log files
        if: ${{ failure() }}
        uses: actions/upload-artifact@v2
        with:
          name: TestLogs
          path: viperServer/logs


  create-nightly-release:
    # this job creates a new nightly pre-release, set viperserver.jar as artifacts, and deletes old releases
    if: (github.event_name == 'workflow_dispatch' && github.event.inputs.type == 'nightly') || github.event_name == 'schedule'
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Download ViperServer artifact
        uses: actions/download-artifact@v2
        with:
          name: viperserver
          path: deploy

      - name: Download version file
        uses: actions/download-artifact@v2
        with:
          name: versions.txt

      - name: Create release tag
        shell: bash
        run: echo "TAG_NAME=$(date +v-%Y-%m-%d-%H%M)" >> $GITHUB_ENV

      - name: Create nightly release
        id: create_release
        uses: viperproject/create-nightly-release@v1
        env:
          # This token is provided by Actions, you do not need to create your own token
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.TAG_NAME }}
          release_name: Nightly Release ${{ env.TAG_NAME }}
          body_path: versions.txt
          keep_num: 1 # keep the previous nightly release such that there are always two

      - name: Upload ViperServer artifact
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: deploy/viperserver.jar
          asset_name: viperserver.jar
          asset_content_type: application/octet-stream


  create-stable-release:
    # this job creates a stable draft-release and set viperserver.jar as artifacts
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.type == 'stable'
    needs: [build-and-test]
    runs-on: ubuntu-latest
    steps:
      - name: Download ViperServer artifact
        uses: actions/download-artifact@v2
        with:
          name: viperserver
          path: deploy

      - name: Download version file
        uses: actions/download-artifact@v2
        with:
          name: versions.txt

      - name: Create stable draft-release
        id: create_release
        uses: actions/create-release@v1
        env:
          # This token is provided by Actions, you do not need to create your own token
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          release_name: ${{ github.event.inputs.release_name }}
          body_path: versions.txt
          draft: true
          prerelease: false

      - name: Upload ViperServer artifact
        uses: actions/upload-release-asset@v1.0.2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: deploy/viperserver.jar
          asset_name: viperserver.jar
          asset_content_type: application/octet-stream
